# 本地智能客服系统 (Agentic RAG)

基于Agentic RAG技术的本地智能客服系统，专为本地部署场景设计，使用Ollama本地模型库提供服务。

## 系统架构

### 核心组件

1. **本地知识库管理**：支持多格式文档处理、语义化分块、向量存储
2. **混合检索策略**：结合向量检索(60%)和关键词检索(40%)
3. **Agent推理框架**：采用Plan-and-Execute+ReAct框架，透明化工具调用
4. **用户反馈系统**：收集反馈并持续优化服务
5. **Web服务接口**：提供RESTful API和友好的前端界面

### 技术栈

- **后端**：Python 3.9+
- **大语言模型**：Ollama本地模型库中的Qwen3-8b
- **嵌入模型**：Qwen3-Embedding
- **向量数据库**：Chroma DB
- **Web框架**：FastAPI
- **前端**：HTML5 + Tailwind CSS + JavaScript

## 项目结构

```
agentic_rag客服系统/
├── app.py                 # 主应用入口
├── requirements.txt       # 依赖管理
├── .env                   # 环境配置
├── core/                  # 核心模块
│   ├── knowledge_base/    # 知识库管理
│   │   ├── __init__.py
│   │   └── manager.py     # 文档处理、存储、模拟数据生成
│   ├── retrieval/         # 检索模块
│   │   ├── __init__.py
│   │   └── hybrid_retriever.py  # 混合检索实现
│   ├── agent/             # Agent模块
│   │   ├── __init__.py
│   │   └── customer_service_agent.py  # 客服Agent实现
│   └── feedback/          # 反馈模块
│       ├── __init__.py
│       └── manager.py     # 反馈收集与分析
├── web/                   # 前端页面
│   └── index.html         # 响应式前端界面
└── data/                  # 数据存储
    ├── documents/         # 原始文档
    ├── vector_db/         # 向量数据库
    └── feedback/          # 反馈数据
```

## 快速开始

### 前置条件

1. **安装Ollama**：从[Ollama官网](https://ollama.com/)下载并安装
2. **下载模型**：
   ```bash
   ollama pull qwen3:8b
   ollama pull dengcao/Qwen3-Embedding-0.6B:F16
   ```
3. **安装Python**：Python 3.9或更高版本

### 安装步骤

1. **克隆项目**：
   ```bash
   git clone <repository-url>
   cd agentic_rag客服系统
   ```

2. **安装依赖**：
   ```bash
   pip install -r requirements.txt
   ```

3. **配置环境**：
   编辑`.env`文件，根据需要调整配置项

4. **启动服务**：
   ```bash
   python app.py
   ```

5. **访问系统**：
   打开浏览器访问 `http://localhost:8000`

## 核心功能

### 1. 本地知识库构建与管理

- **多格式文档支持**：PDF、TXT、Word等
- **语义化分块**：默认300-500字，动态调整
- **模拟数据生成**：自动生成常见客服场景的FAQ和结构化信息
- **实时更新**：支持知识库增删改查

### 2. 混合检索与信息获取

- **检索策略融合**：向量检索(60%) + 关键词检索(40%)
- **动态权重调整**：根据场景自动调整检索权重
- **文档深度处理**：长文档按章节/段落结构化分块
- **意图识别**：根据用户问题类型选择对应检索路径

### 3. Agent推理与透明化工具调用

- **Plan-and-Execute框架**：先拆解问题目标，规划工具调用顺序
- **ReAct循环**：思考-行动-反思，展示完整推理过程
- **工具调用可视化**：实时反馈工具状态，标注信息来源
- **结构化回答**：分点呈现，加粗关键步骤

### 4. 用户反馈与持续优化

- **反馈收集**：回答后提示用户评价，收集补充需求
- **高频问题分析**：自动识别用户反馈中的高频问题
- **优化建议生成**：基于反馈自动生成知识库和系统优化建议
- **系统迭代机制**：定期调整分块策略和工具调用逻辑

## API接口

### 1. 文档上传

```http
POST /api/documents/upload
Content-Type: multipart/form-data

file: <文件>
document_type: <文档类型>
```

### 2. 处理查询

```http
POST /api/query
Content-Type: application/json

{
  "query": "如何申请退款？"
}
```

### 3. 提交反馈

```http
POST /api/feedback
Content-Type: application/json

{
  "query_id": "<查询ID>",
  "is_solved": true,
  "additional_info": "<补充信息>"
}
```

### 4. 健康检查

```http
GET /health
```

## 系统配置

主要配置项位于`.env`文件：

| 配置项 | 描述 | 默认值 |
|-------|------|-------|
| LLM_MODEL | 大语言模型 | qwen3:8b |
| EMBEDDING_MODEL | 嵌入模型 | dengcao/Qwen3-Embedding-0.6B:F16 |
| CHUNK_SIZE | 文档分块大小 | 400 |
| CHUNK_OVERLAP | 分块重叠度 | 50 |
| VECTOR_DB_PATH | 向量数据库路径 | ./data/vector_db |
| DOCUMENTS_PATH | 文档存储路径 | ./data/documents |
| VECTOR_RETRIEVAL_WEIGHT | 向量检索权重 | 0.6 |
| KEYWORD_RETRIEVAL_WEIGHT | 关键词检索权重 | 0.4 |
| TOP_K | 检索结果数量 | 5 |
| HOST | 服务主机 | 0.0.0.0 |
| PORT | 服务端口 | 8000 |

## 使用指南

### 1. 上传文档

1. 点击页面右上角的"上传文档"按钮
2. 选择文档类型（FAQ、公司信息、服务条款、其他）
3. 选择要上传的文件（支持PDF、TXT、Word格式）
4. 点击"上传"按钮完成上传

### 2. 提交查询

1. 在聊天输入框中输入您的问题
2. 点击发送按钮或按Enter键
3. 系统将显示完整的处理过程和答案
4. 您可以在右侧面板查看详细的执行过程

### 3. 提供反馈

1. 系统回答后，在右侧反馈面板中选择"是"或"否"
2. 如果选择"否"，可以填写补充信息描述您的具体需求
3. 点击"提交反馈"按钮
4. 系统会根据反馈持续优化服务

### 4. 查看系统统计

1. 点击页面右上角的"系统统计"按钮
2. 在弹出的模态框中查看系统状态、知识库信息和反馈统计

## 性能优化

1. **模型选择**：根据硬件配置选择合适的模型大小
2. **分块策略**：根据文档类型调整分块大小和重叠度
3. **检索权重**：根据查询类型动态调整向量检索和关键词检索的权重
4. **缓存机制**：启用文档缓存和检索结果缓存
5. **并行处理**：对于大批量文档处理，考虑使用多线程或异步处理

## 故障排除

### 常见问题

1. **服务启动失败**：
   - 检查Ollama服务是否正常运行
   - 确认Qwen3-8b和Qwen3-Embedding模型已正确下载
   - 检查端口8000是否被占用

2. **文档上传失败**：
   - 检查文件格式是否支持（PDF、TXT、Word）
   - 确认文件大小是否合理
   - 查看系统日志了解具体错误

3. **回答质量不佳**：
   - 检查知识库是否包含相关信息
   - 尝试调整检索权重和分块策略
   - 考虑上传更详细的文档到知识库

4. **响应速度慢**：
   - 检查硬件配置是否满足要求
   - 考虑使用更小的模型版本
   - 优化文档分块和检索策略

## 日志管理

系统使用loguru库进行日志记录，主要日志包括：

- **INFO级别**：服务启动、文档处理、检索结果等信息
- **WARNING级别**：知识库为空、反馈数据不足等警告
- **ERROR级别**：服务错误、文档处理失败等错误信息

## 安全注意事项

1. **本地部署**：系统设计为本地部署，不涉及网络调用，确保数据隐私
2. **输入验证**：对用户输入进行严格验证，防止恶意查询
3. **资源限制**：限制上传文件大小和查询频率，防止资源滥用
4. **权限控制**：生产环境应添加适当的访问控制机制

## 未来规划

1. **多语言支持**：添加多语言处理能力
2. **多模态支持**：支持图片、音频等多模态输入
3. **自定义模型**：允许用户选择不同的本地模型
4. **高级分析**：提供更详细的系统性能和用户行为分析
5. **集成能力**：支持与企业现有系统集成

## 许可证

MIT License

## 联系方式

如有问题或建议，请联系系统管理员。
